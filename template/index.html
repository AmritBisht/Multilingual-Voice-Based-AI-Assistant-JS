<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multilingual Voice Chatbot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f8fa;
      margin: 0;
      padding: 0;
    }

    header {
      background: #4a90e2;
      color: white;
      padding: 20px;
      text-align: center;
    }

    #chat {
      max-width: 600px;
      margin: 20px auto;
      padding: 10px;
    }

    .msg {
      padding: 10px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      max-width: 80%;
      clear: both;
    }

    .user {
      background-color: #d1f0ff;
      float: right;
      text-align: right;
    }

    .ai {
      background-color: #e7d8ff;
      float: left;
      text-align: left;
    }

    #controls {
      text-align: center;
      margin: 30px auto;
    }

    #recordBtn {
      background: #ff4b5c;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
    }

    #recordBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #langSelect {
      padding: 8px;
      font-size: 14px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<header>
  <h2>🌍 Multilingual Voice Chatbot</h2>
  <p>Speak your language, hear AI respond in it!</p>
</header>

<div id="chat"></div>

<div id="controls">
  <select id="langSelect">
    <option value="en-US">English 🇺🇸</option>
    <option value="hi-IN">Hindi 🇮🇳</option>
    <option value="fr-FR">French 🇫🇷</option>
    <option value="es-ES">Spanish 🇪🇸</option>
  </select>
  <br>
  <button id="recordBtn" onclick="startRecording()">🎤 Talk</button>
</div>

<script>
let mediaRecorder;
let audioChunks = [];

// Preload voices
let voices = [];
speechSynthesis.onvoiceschanged = () => {
  voices = speechSynthesis.getVoices();
};

async function startRecording() {
  const recordBtn = document.getElementById("recordBtn");
  const lang = document.getElementById("langSelect").value;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append("file", audioBlob, "recording.webm");
      formData.append("language", lang);

      // Add AI "thinking..." message
      const thinkingMsg = addMessage("🤔 Thinking...", "ai");

      try {
        const response = await fetch("https://multilingual-voice-based-ai-assistant-js.onrender.com/process_audio/", {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        thinkingMsg.remove();

        if (data.transcription) {
          addMessage(data.transcription, "user");
        }

        if (data.response) {
          addMessage(data.response, "ai");
          speakText(data.response, lang);
        } else {
          addMessage("⚠️ No response from AI.", "ai");
        }
      } catch (err) {
        thinkingMsg.remove();
        addMessage("❌ Error connecting to server. Please try again.", "ai");
      }

      recordBtn.innerText = "🎤 Talk";
      recordBtn.disabled = false;
    };

    // Start recording
    mediaRecorder.start();
    recordBtn.innerText = "⏺️ Recording...";
    recordBtn.disabled = true;

    // Stop after 5 seconds
    setTimeout(() => mediaRecorder.stop(), 5000);

  } catch (error) {
    addMessage("❌ Microphone access denied or error occurred.", "ai");
    recordBtn.innerText = "🎤 Talk";
    recordBtn.disabled = false;
  }
}

function addMessage(text, sender) {
  const msg = document.createElement("div");
  msg.className = `msg ${sender}`;
  msg.innerText = text;
  document.getElementById("chat").appendChild(msg);
  msg.scrollIntoView({ behavior: "smooth" });
  return msg; // return for potential removal (e.g., "Thinking..." msg)
}

function speakText(text, lang) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = lang;

  // Try to match a voice
  const matchedVoice = voices.find(v => v.lang === lang);
  if (matchedVoice) {
    utterance.voice = matchedVoice;
  }

  speechSynthesis.speak(utterance);
}
</script>

</body>
</html>
